#!/usr/bin/env python3
"""
Compass V2 Data Fetcher
Fetches real options data from Yahoo Finance
Calculates: Risk Premium (IV - HV), Risk Reversal (Call IV - Put IV)
"""

import yfinance as yf
import pandas as pd
import numpy as np
from datetime import datetime
import json
import warnings

warnings.filterwarnings('ignore')

# S√≠mbolos a analizar
SYMBOLS = [
    'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA',
    'JPM', 'BAC', 'WFC', 'DIS', 'NFLX', 'AMD', 'INTC',
    'SPY', 'QQQ', 'IWM', 'TLT', 'COIN', 'PLTR', 'SOFI', 'UBER'
]

def calculate_historical_volatility(ticker, days=20):
    """Calculate historical volatility using log returns"""
    try:
        hist = ticker.history(period='3mo')
        if len(hist) < days:
            return None
        
        log_returns = np.log(hist['Close'] / hist['Close'].shift(1))
        hv = log_returns.tail(days).std() * np.sqrt(252) * 100
        return round(hv, 2)
    except Exception as e:
        print(f"  ‚ö† Error calculating HV: {e}")
        return None

def get_atm_iv(options_chain, option_type='call'):
    """Get ATM implied volatility"""
    try:
        if option_type == 'call':
            chain = options_chain.calls
        else:
            chain = options_chain.puts
        
        if chain.empty:
            return None
        
        # Filter by volume and open interest
        chain = chain[
            (chain['volume'] > 0) & 
            (chain['openInterest'] > 0) &
            (chain['impliedVolatility'] > 0)
        ]
        
        if chain.empty:
            return None
        
        # Get closest to ATM
        chain = chain.iloc[(chain['strike'] - chain['lastPrice'].mean()).abs().argsort()[:3]]
        
        iv = chain['impliedVolatility'].median() * 100
        return round(iv, 2)
        
    except Exception as e:
        print(f"  ‚ö† Error getting {option_type} IV: {e}")
        return None

def fetch_symbol_data(symbol):
    """Fetch all data for a single symbol"""
    print(f"\nüìä Fetching {symbol}...")
    
    try:
        ticker = yf.Ticker(symbol)
        
        # Get current stock info
        info = ticker.info
        current_price = info.get('currentPrice') or info.get('regularMarketPrice')
        
        if not current_price:
            print(f"  ‚ùå No price data")
            return None
        
        # Calculate Historical Volatility
        hv_20 = calculate_historical_volatility(ticker, days=20)
        if hv_20 is None:
            print(f"  ‚ùå Could not calculate HV")
            return None
        
        # Get options chain (closest expiration)
        expirations = ticker.options
        if not expirations:
            print(f"  ‚ùå No options available")
            return None
        
        # Use first expiration (usually closest)
        options = ticker.option_chain(expirations[0])
        
        # Get ATM IV for calls and puts
        call_iv = get_atm_iv(options, 'call')
        put_iv = get_atm_iv(options, 'put')
        
        if call_iv is None or put_iv is None:
            print(f"  ‚ùå Could not get IV data")
            return None
        
        # Calculate current IV (average of call and put)
        current_iv = round((call_iv + put_iv) / 2, 2)
        
        # Calculate Risk Premium (IV - HV)
        risk_premium = round(current_iv - hv_20, 2)
        
        # Calculate Risk Reversal (Call IV - Put IV)
        risk_reversal = round(call_iv - put_iv, 2)
        
        # Calculate IV/HV Ratio
        iv_hv_ratio = round(current_iv / hv_20, 2) if hv_20 > 0 else None
        
        data = {
            'symbol': symbol,
            'current_iv': current_iv,
            'hv_20': hv_20,
            'risk_premium': risk_premium,
            'risk_reversal': risk_reversal,
            'iv_hv_ratio': iv_hv_ratio
        }
        
        print(f"  ‚úì IV: {current_iv}% | HV: {hv_20}% | RP: {risk_premium:+.2f}% | RR: {risk_reversal:+.2f}%")
        return data
        
    except Exception as e:
        print(f"  ‚ùå Error: {e}")
        return None

def main():
    print("=" * 60)
    print("üß≠ COMPASS V2 DATA FETCHER")
    print("=" * 60)
    print(f"Fetching data for {len(SYMBOLS)} symbols...")
    print(f"Timestamp: {datetime.utcnow().isoformat()}Z")
    
    results = []
    
    for symbol in SYMBOLS:
        data = fetch_symbol_data(symbol)
        if data:
            results.append(data)
    
    print("\n" + "=" * 60)
    print(f"‚úì Successfully fetched {len(results)}/{len(SYMBOLS)} symbols")
    print("=" * 60)
    
    # Create output JSON
    output = {
        'metadata': {
            'version': '2.0',
            'last_updated': datetime.utcnow().isoformat() + 'Z',
            'source': 'Yahoo Finance',
            'calculation_method': 'real_metrics'
        },
        'symbols_count': len(results),
        'data': results
    }
    
    # Save to file
    with open('compass-data.json', 'w') as f:
        json.dump(output, f, indent=2)
    
    print(f"\nüíæ Saved to compass-data.json")
    
    # Print summary statistics
    if results:
        avg_rp = sum(d['risk_premium'] for d in results) / len(results)
        avg_rr = sum(d['risk_reversal'] for d in results) / len(results)
        avg_iv = sum(d['current_iv'] for d in results) / len(results)
        
        print(f"\nüìà SUMMARY:")
        print(f"   Avg Risk Premium: {avg_rp:+.2f}%")
        print(f"   Avg Risk Reversal: {avg_rr:+.2f}%")
        print(f"   Avg IV: {avg_iv:.2f}%")

if __name__ == '__main__':
    main()
